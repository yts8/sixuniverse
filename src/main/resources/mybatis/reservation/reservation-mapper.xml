<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yts8.sixuniverse.reservation.repository.ReservationMapper">
  <insert id="reservationInsert" parameterType="ReservationDateDto" useGeneratedKeys="true" keyProperty="reservationId">
    insert into reservation
    values (null, #{roomId}, #{memberId}, #{status}, #{adult}, #{kid}, #{infant}, #{checkIn}, #{checkOut},
            #{createDate}, #{cancelDate}, #{updateTarget})
  </insert>

  <select id="reservationList" parameterType="ReservationDateDto" resultType="ReservationDto">
    select *
    from reservation
    where member_id = #{memberId}
      and status = #{status}
      and update_target is null
    order by check_in
  </select>

  <select id="hostReservationList" parameterType="ReservationDto" resultType="HostReservationDto">
    select r.status,
    room.room_id,
    room.title,
    r.reservation_id,
    r.member_id,
    r.check_in,
    r.check_out,
    r.create_date,
    r.adult,
    r.kid,
    r.infant,
    p.commission,
    p.price,
    m.member_id,
    m.username
    from room
    join reservation r on room.room_id = r.room_id
    join payment p on r.reservation_id = p.reservation_id
    join member m on m.member_id = r.member_id
    where room.member_id = #{memberId}
    <if test='!status.equals("all")'>
      and r.status = #{status};
    </if>
  </select>

  <select id="HostDetailInfo" resultType="HostDetailInfoDto">
    select gm.member_id                                                              as guest_member_id,
           gm.username,
           gm.profile_img,
           r.status,
           (r.check_out - r.check_in)                                                as date_sub,
           room.price,
           room.title,
           ((review.score_service + review.score_clean + review.score_location) / 3) as score_all,
           review.review_content,
           gm.address,
           gm.host_grade,
           gm.mobile,
           hm.member_id                                                              as host_member_id,
           r.adult,
           r.kid,
           r.infant,
           r.check_in,
           r.check_out,
           r.create_date,
           r.member_id,
           r.reservation_id,
           p.commission,
           p.mileage,
           p.price                                                                   as total_price
    from reservation r
           join member gm on gm.member_id = r.member_id
           left join review on r.reservation_id = review.reservation_id
           join room on r.room_id = room.room_id
           join member hm on room.member_id = hm.member_id
           join payment p on r.reservation_id = p.reservation_id
    where r.reservation_id = #{reservationId}
  </select>

  <select id="findById" parameterType="ReservationDateDto" resultType="ReservationDto">
    select *
    from reservation
    where reservation_id = #{reservationId}
  </select>

  <update id="reservationCheckOut">
    update reservation
    set status = 'complete'
    where check_out <![CDATA[ < ]]> #{today}
      and status = 'upcoming'
  </update>

  <update id="guestReservationUpdateRequest">
    update reservation
    set status = 'update'
    where reservation_id = #{reservationId}
  </update>

  <insert id="guestReservationUpdateInsert">
    insert into reservation (room_id, member_id, status, adult, kid, infant, check_in, check_out, update_target)
    values (#{roomId}, #{memberId}, #{status}, #{adult}, #{kid}, #{infant}, #{checkIn}, #{checkOut}, #{reservationId})
  </insert>

  <update id="hostUpdate">
    update reservation
    set status = #{status}
    where update_target = #{reservationId}
  </update>

  <update id="hostUpdateNo">
    update reservation
    set status = 'upcoming'
    where reservation_id = #{reservationId}
  </update>

  <select id="updateList" resultType="ReservationDto">
    select reservation_id, status, update_target
    from reservation
    where update_target is not null
  </select>

  <select id="findByUpdateTarget" resultType="ReservationDto">
    select reservation_id, room_id, adult, kid, infant, check_in, check_out
    from reservation
    where update_target = #{reservationId}
  </select>

  <update id="guestReservationUpdate">
    update reservation
    set status    = 'upcoming',
        adult     = #{adult},
        kid       = #{kid},
        infant    = #{infant},
        check_in  = #{checkIn},
        check_out = #{checkOut}
    where reservation_id = #{reservationId}
  </update>

  <delete id="reservationDelete">
    delete
    from reservation
    where reservation_id = #{reservationId}
  </delete>

  <update id="guestReservationCancel">
    update reservation
    set cancel_date = #{cancelDate},
        status      = #{status}
    where reservation_id = #{reservationId}
  </update>

  <select id="findByUpdateReservationId" resultType="ReservationRoomPaymentDto">
    select reservation.reservation_id,
           reservation.room_id,
           reservation.status,
           adult,
           kid,
           infant,
           check_in,
           check_out,
           room.address,
           room.sub_address,
           room.price as room_price,
           title,
           m.member_id as host_id,
           m.username,
           p.payment_id,
           p.price,
           p.commission,
           room_img.room_img
    from reservation
           join room on reservation.room_id = room.room_id
           join room_img on room.room_id = room_img.room_id
           join member m on room.member_id = m.member_id
           left outer join payment p on reservation.reservation_id = p.reservation_id
    where reservation.update_target = #{reservationId}
       or reservation.reservation_id = #{reservationId}
    group by reservation.reservation_id
  </select>

  <select id="findByCancelReservationId" resultType="ReservationRoomPaymentDto">
    select reservation.reservation_id,
           reservation.room_id,
           reservation.status,
           adult,
           kid,
           infant,
           check_in,
           check_out,
           room.address,
           room.sub_address,
           title,
           m.member_id as host_id,
           m.username,
           p.payment_id,
           p.price,
           p.commission,
           room_img.room_img
    from reservation
           join room on reservation.room_id = room.room_id
           join room_img on room.room_id = room_img.room_id
           join member m on room.member_id = m.member_id
           join payment p on reservation.reservation_id = p.reservation_id
    where reservation.reservation_id = #{reservationId}
    group by reservation.reservation_id
  </select>


</mapper>