<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yts8.sixuniverse.chat.repository.ChatMapper">

  <!--채팅메세지 insert-->
  <insert id="saveMessage" parameterType="ChatDto" useGeneratedKeys="true" keyProperty="chatId">
    insert into chat (member_id, content,join_num)
    values (#{memberId}, #{content},#{joinNum})
  </insert>

  <insert id="createChatroomJoin" parameterType="ChatroomJoinDto" useGeneratedKeys="true" keyProperty="joinNum">
    insert into chatroom_join (member_id, name, chat_ref)
    values (#{memberId}, #{name}, #{chatRef})
  </insert>

  <!--채팅방목록 출력용 최근 항목만 받아오기(전체최근항목으로변경하기)-->
  <select id="findMessage" resultType="chatDto">
    select *
    from chat
    where member_id = #{memberId}
    order by create_date desc
    limit 1

  </select>


  <insert id="createNewRoom" parameterType="ChatroomJoinDto" useGeneratedKeys="true" keyProperty="joinNum">
    insert into chatroom_join (member_id, name, chat_ref)
    values (#{memberId}, #{userName}, #{realChatRef})
  </insert>

  <!--Long getChatRef(Long myMemberId, Long hostId);-->
  <select id="getChatRef" resultType="java.lang.Long">
    SELECT chat_ref
    FROM chatroom_join
    WHERE member_id NOT IN (#{hostId}, #{myMemberId})
    GROUP BY chat_ref;
  </select>

  <!--Long createNewChatRef();-->
  <select id="createNewChatRef" resultType="java.lang.Long">
    SELECT MAX(chat_ref) + 1
    FROM chatroom_join;
  </select>


  <insert id="testCreateNewRoom" parameterType="ChatroomJoinDto" useGeneratedKeys="true" keyProperty="joinNum">
    insert into chatroom_join (member_id, name, chat_ref)
    values (#{memberId}, #{name}, #{chatRef})
  </insert>






  <!--호스트ID -->
  <select id="getHostChatRef" resultType="java.lang.Long">
    select chat_ref
    from chatroom_join
    where member_id = #{hostId}
  </select>

  <select id="getMyChatRef" resultType="java.lang.Long">
    select chat_ref
    from chatroom_join
    where member_id = #{myMemberId}
  </select>

</mapper>
